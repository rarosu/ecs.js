/*! ecs 2015-12-06 */
var ECS=function(){"use strict";function a(b){var c;if(null===b||"object"!=typeof b)return b;if(b instanceof Date)return c=new Date,c.setTime(b.getTime()),c;if(b instanceof Array){c=[];for(var d=0,e=b.length;e>d;d++)c[d]=a(b[d]);return c}if(b instanceof Object){c={};for(var f in b)b.hasOwnProperty(f)&&(c[f]=a(b[f]));return c}throw new Error("Unable to clone object. Type unsupported.")}function b(){this.componentNames=[],this.entities=[],this.nextEntity=0,this.isProcessing=!1}var c={};return Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){null===b?b=0:0>b&&(b=Math.max(0,this.length+b));for(var c=b,d=this.length;d>c;c++)if(this[c]===a)return c;return-1}),b.prototype.first=function(){return this.nextEntity=0,this.isProcessing=!0,this.next()},b.prototype.next=function(){return this.nextEntity>=this.entities.length?void(this.isProcessing=!1):this.entities[this.nextEntity++]},c.EntityManager=function(){this.uid=0,this.entities=[],this.childEntities={},this.components={},this.componentEntityTable={},this.processors=[],this.entityFilters=[],this.componentObservers=[],this.entityObservers=[],this.entityTags={}},c.EntityManager.prototype.registerComponent=function(a,b){if(a in this.components)throw Error("Component type "+a+" already registered.");this.components[a]=b,this.componentEntityTable[a]={}},c.EntityManager.prototype.unregisterComponent=function(a){var b;for(b=0;b<this.entityFilters.length;b++){var c=this.entityFilters[b].componentNames.indexOf(a);if(-1!=c)if(this.entityFilters[b].componentNames.splice(c,1),0===this.entityFilters[b].componentNames.length)this.entityFilters[b].entities=[];else{var d,e=this.getEntitiesByComponents(this.entityFilters[b].componentNames);for(d=0;d<e.length;d++)-1==this.entityFilters[b].entities.indexOf(e[d])&&this.entityFilters[b].entities.push(e[d])}}for(b=0;b<this.componentObservers.length;b++){if(-1!=this.componentObservers[b].observerComponentNames.indexOf(a))for(var f in this.componentEntityTable[a])this.componentObservers[b].componentRemoved(parseInt(f,10),a);this.componentObservers[b].observerComponentNames.splice(this.componentObservers[b].observerComponentNames.indexOf(a),1)}delete this.components[a],delete this.componentEntityTable[a]},c.EntityManager.prototype.createEntity=function(a,b){var c=this.uid++;this.entities.push(c);var d;if(void 0!==a)for(d=0;d<a.length;d++)this.addComponent(c,a[d]);void 0!==b&&(b in this.childEntities||(this.childEntities[b]=[]),this.childEntities[b].push(c));for(d=0;d<this.entityObservers.length;d++)this.entityObservers[d].entityCreated(c);return c},c.EntityManager.prototype.createMessage=function(a,b){var c=this.createEntity(b);return a.emittedMessages.push(c),c},c.EntityManager.prototype.removeEntity=function(a){var b=this.entities.indexOf(a);if(-1!=b){var c;if(a in this.childEntities){for(c=0;c<this.childEntities[a].length;c++)this.removeEntity(this.childEntities[a][c]);delete this.childEntities[a]}for(c=0;c<this.entityFilters.length;c++){var d=this.entityFilters[c].entities.indexOf(a);-1!=d&&(this.entityFilters[c].entities.splice(d,1),this.entityFilters[c].isProcessing&&d<this.entityFilters[c].nextEntity&&this.entityFilters[c].nextEntity--)}var e;for(e in this.componentEntityTable)if(a in this.componentEntityTable[e])for(c=0;c<this.componentObservers.length;c++)-1!=this.componentObservers[c].observerComponentNames.indexOf(e)&&this.componentObservers[c].componentRemoved(parseInt(a,10),e);for(c=0;c<this.entityObservers.length;c++)this.entityObservers[c].entityRemoved(a);for(var f in this.entityTags)this.entityTags[f]==a&&delete this.entityTags[f];this.entities.splice(b,1);for(e in this.componentEntityTable)a in this.componentEntityTable[e]&&delete this.componentEntityTable[e][a]}},c.EntityManager.prototype.isActiveEntity=function(a){return-1!=this.entities.indexOf(a)},c.EntityManager.prototype.isDestroyedEntity=function(a){return-1==this.entities.indexOf(a)&&a<this.uid&&a>=0},c.EntityManager.prototype.addTag=function(a,b){this.entityTags[b]=a},c.EntityManager.prototype.removeTag=function(a){delete this.entityTags[a]},c.EntityManager.prototype.getEntityByTag=function(a){return this.entityTags[a]},c.EntityManager.prototype.addComponent=function(b,c){if(!(b in this.componentEntityTable[c])){this.componentEntityTable[c][b]=a(this.components[c]);var d;for(d=0;d<this.entityFilters.length;d++)if(-1==this.entityFilters[d].entities.indexOf(b)){var e,f=!0;for(e=0;e<this.entityFilters[d].componentNames.length;e++)if(!(b in this.componentEntityTable[this.entityFilters[d].componentNames[e]])){f=!1;break}f&&this.entityFilters[d].entities.push(b)}for(d=0;d<this.componentObservers.length;d++)-1!=this.componentObservers[d].observerComponentNames.indexOf(c)&&this.componentObservers[d].componentAdded(b,c)}},c.EntityManager.prototype.addComponents=function(a,b){var c;for(c=0;c<b.length;c++)this.addComponent(a,b[c])},c.EntityManager.prototype.removeComponent=function(a,b){var c;for(c=0;c<this.entityFilters.length;c++)if(-1!=this.entityFilters[c].componentNames.indexOf(b)){var d=this.entityFilters[c].entities.indexOf(a);this.entityFilters[c].entities.splice(d,1)}for(c=0;c<this.componentObservers.length;c++)-1!=this.componentObservers[c].observerComponentNames.indexOf(b)&&this.componentObservers[c].componentRemoved(a,b);delete this.componentEntityTable[b][a]},c.EntityManager.prototype.getComponent=function(a,b){return this.componentEntityTable[b][a]},c.EntityManager.prototype.getEntitiesByComponents=function(a){var b=[];for(var c in this.componentEntityTable[a[0]]){var d,e=!0;for(d=1;d<a.length;d++)if(!(c in this.componentEntityTable[a[d]])){e=!1;break}e&&b.push(parseInt(c,10))}return b},c.EntityManager.prototype.registerProcessor=function(a){this.processors.push(a),a.emittedMessages=[]},c.EntityManager.prototype.unregisterProcessor=function(a){this.processors.splice(this.processors.indexOf(a));var b;for(b=0;b<a.emittedMessages.length;b++)this.removeEntity(a.emittedMessages[b]);delete a.emittedMessages},c.EntityManager.prototype.update=function(){var a;for(a=0;a<this.processors.length;a++){var b,c=this.processors[a];for(b=0;b<c.emittedMessages.length;b++)this.removeEntity(c.emittedMessages[b]);c.emittedMessages=[],c.update()}},c.EntityManager.prototype.createEntityFilter=function(a){var c=new b;return c.componentNames=a,c.entities=this.getEntitiesByComponents(c.componentNames),this.entityFilters.push(c),c},c.EntityManager.prototype.removeEntityFilter=function(a){var b=this.entityFilters.indexOf(a);-1!=b&&this.entityFilters.splice(b,1)},c.EntityManager.prototype.registerEntityObserver=function(a){this.entityObservers.push(a)},c.EntityManager.prototype.unregisterEntityObserver=function(a){this.entityObservers.splice(this.entityObservers.indexOf(a))},c.EntityManager.prototype.registerComponentObserver=function(a,b){a.observerComponentNames=b,this.componentObservers.push(a)},c.EntityManager.prototype.unregisterComponentObserver=function(a){delete a.observerComponentNames,this.componentObservers.splice(this.componentObservers.indexOf(a),1)},c.EntityManager.prototype.addComponentObserverComponent=function(a,b){a.observerComponentNames.push(b)},c.EntityManager.prototype.removeComponentObserverComponent=function(a,b){var c=a.observerComponentNames.indexOf(b);-1!=c&&a.observerComponentNames.splice(c,1)},c}();