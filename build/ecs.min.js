/*! ecs 2015-09-11 */
var ECS=function(){"use strict";function a(b){var c;if(null===b||"object"!=typeof b)return b;if(b instanceof Date)return c=new Date,c.setTime(b.getTime()),c;if(b instanceof Array){c=[];for(var d=0,e=b.length;e>d;d++)c[d]=a(b[d]);return c}if(b instanceof Object){c={};for(var f in b)b.hasOwnProperty(f)&&(c[f]=a(b[f]));return c}throw new Error("Unable to clone object. Type unsupported.")}var b={};return Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){null===b?b=0:0>b&&(b=Math.max(0,this.length+b));for(var c=b,d=this.length;d>c;c++)if(this[c]===a)return c;return-1}),b.EntityManager=function(){this.entities=[],this.removedEntities=[],this.components={},this.componentEntityTable={},this.processors=[],this.processorNames=[],this.processorComponents=[],this.processorEntities=[],this.componentObservers=[],this.componentObserverComponents=[],this.entityObservers=[],this.entityTags={},this.uid=0},b.EntityManager.prototype.registerComponent=function(a,b){if(a in this.components)throw Error("Component type "+a+" already registered.");this.components[a]=b,this.componentEntityTable[a]={}},b.EntityManager.prototype.unregisterComponent=function(a){var b;for(b=0;b<this.processors.length;b++){var c=this.processorComponents[b].indexOf(a);if(-1!=c)if(this.processorComponents[b].splice(c,1),0===this.processorComponents[b].length)this.processorEntities[b]=[];else{var d,e=this.getEntitiesByComponents(this.processorComponents[b]);for(d=0;d<e.length;d++)-1==this.processorEntities[b].indexOf(e[d])&&this.processorEntities[b].push(e[d])}}for(b=0;b<this.componentObserverComponents.length;b++)if(-1!=this.componentObserverComponents[b].indexOf(a))for(var f in this.componentEntityTable[a])this.componentObservers[b].componentRemoved(f,a);for(b=0;b<this.componentObservers.length;b++)this.componentObserverComponents[b].splice(this.componentObserverComponents[b].indexOf(a),1);delete this.components[a],delete this.componentEntityTable[a]},b.EntityManager.prototype.createEntity=function(a){var b=this.uid++;this.entities.push(b);var c;if(a)for(c=0;c<a.length;c++)this.addComponent(b,a[c]);for(c=0;c<this.entityObservers.length;c++)this.entityObservers[c].entityCreated(b);return b},b.EntityManager.prototype.removeEntity=function(a){var b=this.entities.indexOf(a);if(-1!=b){this.entities.splice(b,1),this.removedEntities.push(a);var c;for(c=0;c<this.processors.length;c++){var d=this.processorEntities[c].indexOf(a);-1!=d&&this.processorEntities[c].splice(d,1)}for(var e in this.componentEntityTable)if(a in this.componentEntityTable[e])for(c=0;c<this.componentObserverComponents.length;++c)-1!=this.componentObserverComponents[c].indexOf(e)&&this.componentObservers[c].componentRemoved(a,e);for(c=0;c<this.entityObservers.length;c++)this.entityObservers[c].entityRemoved(a);for(var f in this.entityTags)this.entityTags[f]==a&&delete this.entityTags[f]}},b.EntityManager.prototype.isActiveEntity=function(a){return-1!=this.entities.indexOf(a)},b.EntityManager.prototype.isRemovedEntity=function(a){return-1!=this.removedEntities.indexOf(a)},b.EntityManager.prototype.isDestroyedEntity=function(a){return-1==this.entities.indexOf(a)&&-1==this.removedEntities.indexOf(a)&&a<this.uid&&a>=0},b.EntityManager.prototype._destroyRemovedEntities=function(){var a;for(a=0;a<this.removedEntities.length;a++)for(var b in this.componentEntityTable)this.removedEntities[a]in this.componentEntityTable[b]&&delete this.componentEntityTable[b][this.removedEntities[a]];this.removedEntities=[]},b.EntityManager.prototype.addTag=function(a,b){this.entityTags[b]=a},b.EntityManager.prototype.removeTag=function(a){delete this.entityTags[a]},b.EntityManager.prototype.getEntityByTag=function(a){return this.entityTags[a]},b.EntityManager.prototype.addComponent=function(b,c){if(!(b in this.componentEntityTable[c])){this.componentEntityTable[c][b]=a(this.components[c]);var d;for(d=0;d<this.processors.length;d++)if(-1==this.processorEntities[d].indexOf(b)){for(var e=!0,f=0;f<this.processorComponents[d].length;f++)if(!(b in this.componentEntityTable[this.processorComponents[d][f]])){e=!1;break}e&&this.processorEntities[d].push(b)}for(d=0;d<this.componentObserverComponents.length;d++)-1!=this.componentObserverComponents[d].indexOf(c)&&this.componentObservers[d].componentAdded(b,c)}},b.EntityManager.prototype.addComponents=function(a,b){var c;for(c=0;c<b.length;c++)this.addComponent(a,b[c])},b.EntityManager.prototype.removeComponent=function(a,b){var c;for(c=0;c<this.processors.length;c++)if(-1!=this.processorComponents[c].indexOf(b)){var d=this.processorEntities[c].indexOf(a);this.processorEntities[c].splice(d,1)}for(c=0;c<this.componentObserverComponents.length;c++)-1!=this.componentObserverComponents[c].indexOf(b)&&this.componentObservers[c].componentRemoved(a,b);delete this.componentEntityTable[b][a]},b.EntityManager.prototype.getComponent=function(a,b){return this.componentEntityTable[b][a]},b.EntityManager.prototype.getEntitiesDataByComponent=function(a){return this.componentEntityTable[a]},b.EntityManager.prototype.getEntitiesByComponents=function(a){var b=[];for(var c in this.componentEntityTable[a[0]]){var d,e=!0;for(d=1;d<a.length;d++)if(!(c in this.componentEntityTable[a[d]])){e=!1;break}e&&b.push(parseInt(c))}return b},b.EntityManager.prototype.registerProcessor=function(a,b){this.processors.push(a),this.processorComponents.push(b),this.processorEntities.push(this.getEntitiesByComponents(this.processorComponents[this.processorComponents.length-1]))},b.EntityManager.prototype.unregisterProcessor=function(a){var b=this.processors.indexOf(a);this.processors.splice(b,1),this.processorComponents.splice(b,1),this.processorEntities.splice(b,1)},b.EntityManager.prototype.getEntitiesByProcessor=function(a){return this.processorEntities[this.processors.indexOf(a)]},b.EntityManager.prototype.update=function(){this._destroyRemovedEntities();var a;for(a=0;a<this.processors.length;a++){var b=this.processors[a];b.update(),this._destroyRemovedEntities()}},b.EntityManager.prototype.registerEntityObserver=function(a){this.entityObservers.push(a)},b.EntityManager.prototype.unregisterEntityObserver=function(a){this.entityObservers.splice(this.entityObservers.indexOf(a))},b.EntityManager.prototype.registerComponentObserver=function(a,b){this.componentObservers.push(a),this.componentObserverComponents.push(b)},b.EntityManager.prototype.unregisterComponentObserver=function(a){var b=this.componentObservers.indexOf(a);this.componentObservers.splice(b,1),this.componentObserverComponents.splice(b,1)},b.EntityManager.prototype.addComponentObserverComponent=function(a,b){this.componentObserverComponents[this.componentObservers.indexOf(a)].push(b)},b.EntityManager.prototype.removeComponentObserverComponent=function(a,b){var c=this.componentObserverComponents[this.componentObservers.indexOf(a)].indexOf(b);this.componentObserverComponents[this.componentObservers.indexOf(a)].splice(c,1)},b}();